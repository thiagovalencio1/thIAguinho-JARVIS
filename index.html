<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThIAguinho J.A.R.V.I.S.</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.6.12/dist/vuetify.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a, #2b2c39);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .jarvis-card {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 140, 255, 0.5);
            margin: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 30px rgba(0, 140, 255, 0.5); }
            50% { box-shadow: 0 0 60px rgba(0, 140, 255, 0.2); }
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-container>
                <v-card class="jarvis-card" elevation="10">
                    <v-card-title>ThIAguinho J.A.R.V.I.S.</v-card-title>
                    <v-card-subtitle>Seu Mecânico Virtual Inteligente</v-card-subtitle>

                    <v-btn @click="connectBluetooth" color="primary" :disabled="connected">
                        {{ connected ? 'Conectado' : 'Conectar ao ELM327' }}
                    </v-btn>

                    <v-text-field v-model="apiKey" label="Chave OpenAI" placeholder="sk-proj-..." persistent-placeholder></v-text-field>

                    <v-card v-if="connected" class="mt-4">
                        <v-card-title>Dados do Veículo</v-card-title>
                        <v-card-text>
                            <p>RPM: {{ rpm }}</p>
                            <p>Velocidade: {{ speed }} km/h</p>
                            <p>Temperatura: {{ temperature }} °C</p>
                        </v-card-text>
                    </v-card>

                    <v-textarea v-model="diagnosis" label="Diagnóstico da IA" auto-grow readonly></v-textarea>
                </v-card>
            </v-container>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.6.12/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.6.12/dist/vuetify.min.js"></script>
    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify();

        createApp({
            vuetify,
            data() {
                return {
                    connected: false,
                    device: null,
                    apiKey: '',
                    rpm: 0,
                    speed: 0,
                    temperature: 0,
                    diagnosis: ''
                };
            },
            methods: {
                async connectBluetooth() {
                    try {
                        this.device = await navigator.bluetooth.requestDevice({
                            filters: [{ services: ['00001101-0000-1000-8000-00805f9b34fb'] }]
                        });
                        const server = await this.device.gatt.connect();
                        const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                        const characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');

                        setInterval(async () => {
                            await characteristic.writeValue(new TextEncoder().encode('010C1\r'));
                            const value = await characteristic.readValue();
                            this.rpm = this.parseRPM(value);
                        }, 1000);

                        this.connected = true;
                    } catch (error) {
                        alert('Erro ao conectar: ' + error);
                    }
                },
                parseRPM(value) {
                    const hex = Array.from(new Uint8Array(value.buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
                    return parseInt(hex, 16) / 4;
                },
                async diagnose() {
                    if (!this.apiKey) {
                        alert('Insira sua chave da OpenAI!');
                        return;
                    }

                    const prompt = `Veículo com RPM ${this.rpm}, velocidade ${this.speed} km/h e temperatura ${this.temperature}°C. Diagnóstico J.A.R.V.I.S.:`;
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 300
                        })
                    });
                    const data = await response.json();
                    this.diagnosis = data.choices[0].message.content;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
